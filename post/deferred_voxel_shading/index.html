<!DOCTYPE html>
<html lang="en-us">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

 <title>Deferred Voxel Shading for Real Time Global Illumination</title>



<meta name="description" content="José Villegas blog for game and graphics programming">


<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">

<link rel="stylesheet" href="https://jose-villegas.github.io/css/bootstrap.min.css">
<link rel="stylesheet" id="ct-tracks-google-fonts-css" href="//fonts.googleapis.com/css?family=Raleway%3A400%2C700&amp;subset=latin%2Clatin-ext&amp;ver=4.7.2" type="text/css" media="all">
<link rel="stylesheet" href="https://jose-villegas.github.io/css/font-awesome.min.css">

<link href="https://jose-villegas.github.io/css/style.default.css" rel="stylesheet" id="theme-stylesheet">

<link href="https://jose-villegas.github.io/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://jose-villegas.github.io/img/favicon.png">


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-97909433-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>

</head>
  <body>
    <div id="root">
      <div class="container-fluid">
        <div class="row site-header">
          <div class="col-md-12">
            <div class="row">
              <div class="col-md-12 top-navigation">
                <div class="row">
  <div class="col-sm-6">
    <div class="categories-block">
      <a href="" class="track-categories">//</a>
      
      <a href="/categories/graphics">graphics</a>
      
      <a href="/categories/portfolio">portfolio</a>
      
    </div>
  </div>

  <div class="col-sm-6">
    <div class="social-media-block">

      
      
      
      
      
      <a href="mailto:villegasjose.gg@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope"></i>
      </a>
      
      
      <a href="https://www.linkedin.com/in/villegasjose" data-animate-hover="pulse">
        <i class="fa fa-linkedin"></i>
      </a>
      
      
      
      <a href="https://github.com/jose-villegas" data-animate-hover="pulse">
        <i class="fa fa-github"></i>
      </a>
      

    </div>
  </div>
</div>

              </div>
            </div>
            <div class="row">
              <div class="col-md-10 header col-md-offset-1">
                <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<div class="row">
  <div class="col-md-6">
    <div class="title-info">
      
      <a href=""> José Villegas </a>
      
    </div>
  </div>
  <div class="col-md-6">
    <div class="menu">
      
      
        <a href="https://jose-villegas.github.io/">Home / </a>
      
        <a href="https://jose-villegas.github.io/about/index">About / </a>
      
        <a href="https://jose-villegas.github.io/contact/index">Contact / </a>
      
    </div>
  </div>

</div>


              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-10 main-content col-md-offset-1">
            

<div class="col-md-12 entry">
  <div class="row">
    <div class="col-md-12">
      <div class="entry-meta">
        June 17
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="entry-header">
       Deferred Voxel Shading for Real Time Global Illumination
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-2">
      <div class="entry-sidebar">
        CATEGORIES
        
        <div class="entry-categories">
          <a href="/categories/graphics">graphics</a>
        </div>
        
        <div class="entry-categories">
          <a href="/categories/portfolio">portfolio</a>
        </div>
        

        Tags
        

      </div>
    </div>
    <div class="col-md-10">
      <div class="entry-content">
        <p>Computing indirect illumination is a challenging and complex problem for real-time rendering in 3D applications. This global illumination approach computes indirect lighting in real time utilizing a simpliﬁed version of the outgoing radiance and the scene stored in voxels.
</p>

<p>Deferred voxel shading is a four-step real-time global illumination technique inspired by voxel cone tracing and deferred rendering. This approach enables us to approximate 2-bounce indirect diffuse, specular reflectance, emissive materials, indirect shadows and ambient occlusion.</p>

<p>The first step is voxelize the scene, my implemention voxelizes scene albedo, normal and emission to approximate emissive materials. For this atomic operations on 3D textures are used as described <a href="https://www.seas.upenn.edu/~pcozzi/OpenGLInsights/OpenGLInsights-SparseVoxelization.pdf">here</a>; the average albedo, normal and emission of all the geometry within a voxel is stored in 3D volumes, these volumes are later used to calculate voxel illumination. Unlike other approaches that store radiance directly into the voxel structure I utilize the 3D volumes as deferred rendering does with its geometry buffer for a separate stage for lighting calculations, this has the advantage of being generally faster but requires more memory.</p>

<pre><code class="language-c">...
layout(binding = 0, r32ui) uniform volatile coherent uimage3D voxelAlbedo;
layout(binding = 1, r32ui) uniform volatile coherent uimage3D voxelNormal;
layout(binding = 2, r32ui) uniform volatile coherent uimage3D voxelEmission;
...
// average normal per fragments sorrounding the voxel volume
imageAtomicRGBA8Avg(voxelNormal, position, normal);
// average albedo per fragments sorrounding the voxel volume
imageAtomicRGBA8Avg(voxelAlbedo, position, albedo);
// average emission per fragments sorrounding the voxel volume
imageAtomicRGBA8Avg(voxelEmission, position, emissive);
...
</code></pre>

<table>
<thead>
<tr>
<th align="center">Scene</th>
<th align="center">Average Albedo</th>
<th align="center">Average Normal</th>
<th align="center">Average Emission</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323827/DVSGI/scene_culelk.png" alt="" /></td>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323820/DVSGI/v_albedo_qtc4ov.png" alt="" /></td>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323804/DVSGI/v_normal_ryzmrh.png" alt="" /></td>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323828/DVSGI/v_emission_aibyaf.png" alt="" /></td>
</tr>
</tbody>
</table>

<p>The next step is voxel illumination, for this we calculate the outgoing radiance per voxel using the data stored from the voxelization step. For this we only need the voxel normal, and its position which can be easily extracted by projecting the voxel 3D coordinates in world-space, then we calculate direct lighting per voxel and add the voxel&rsquo;s emissive value.</p>

<table>
<thead>
<tr>
<th align="center">Scene</th>
<th align="center">Voxel Direct Lighting</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323827/DVSGI/scene_culelk.png" alt="" /></td>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_195/v1497323829/DVSGI/v_direct_vrnajc.png" alt="" /></td>
</tr>
</tbody>
</table>

<p>A disvantage of this technique is the loss of precision averaging all the geometry normals within a voxel. The resulting averaged normal may end up pointing towards a non-convenient direction. This problem is notable when the normal vectors within the space of a voxel are uneven.</p>

<p><img src="http://res.cloudinary.com/jose-villegas/image/upload/v1497413810/DVSGI/uneven_normals_n3klcb.svg" alt="" /></p>

<p>To reduce this issue my proposal utilizes a normal-weighted attenuation, where first the normal attenuation is calculated per every face of the voxel as follows:</p>

<p>\begin{equation}
D_{x,y,z} = (\hat{i}\cdot\Psi, \hat{j}\cdot\Psi, \hat{k}\cdot\Psi)
\end{equation}</p>

<p>Then three dominant faces are selected depending on the axes sign of the voxel averaged normal vector:</p>

<p>\begin{equation}
D_{\omega} =
\begin{cases}
max\{D_\omega, 0\}, &amp; N_\omega&gt;0\\
max\{-D_\omega, 0\}, &amp; \text{otherwise}
\end{cases}
\end{equation}</p>

<p>And finally, the resulting attenuation is the product of every dominant face normal attenuation, multiplied with the weight per axis of the averaged normal vector of the voxel, the resulting reflectance model is computed as follows:</p>

<p>\begin{equation}
\begin{split}
W &amp;= N^2\\
V_{r} &amp;= L_{i}\frac{\rho}{\pi}(W_x D_x + W_y D_y + W_z D_z)
\end{split}
\end{equation}
where \(L_i\) is the light source intensity, \(\rho\) the voxel albedo, \(N\) the normal vector of the voxel and \(\Psi\) the light direction.</p>

<table>
<thead>
<tr>
<th align="center">Normal attenuation</th>
<th align="center">Normal-weighted attenuation</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_450/v1497414410/DVSGI/shading_standard_e7vzft.png" alt="" />&nbsp;</td>
<td align="center"><img src="http://res.cloudinary.com/jose-villegas/image/upload/c_scale,w_450/v1497414410/DVSGI/shading_directional_uwyxxw.png" alt="" /></td>
</tr>
</tbody>
</table>
      </div>
    </div>
  </div>

  <hr/>
  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'https-jose-villegas-github-io';
    var disqus_identifier = 'https:\/\/jose-villegas.github.io\/post\/deferred_voxel_shading\/';
    var disqus_title = 'Deferred Voxel Shading for Real Time Global Illumination';
    var disqus_url = 'https:\/\/jose-villegas.github.io\/post\/deferred_voxel_shading\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</div>

          </div>
        </div>
        <div class="row site-footer">
          <div class="col-md-12">
            <div class="row">
  <div class="col-md-12 footer-menu">
      
      
        <a href="https://jose-villegas.github.io/">Home / </a>
      
        <a href="https://jose-villegas.github.io/about/index">About / </a>
      
        <a href="https://jose-villegas.github.io/contact/index">Contact / </a>
      

  </div>
</div>
<div class="row">
  <div class="col-sm-12">
    <div class="social-media-block-footer">
      
      
      
      
      
      <a href="mailto:villegasjose.gg@gmail.com" data-animate-hover="pulse" class="email">
        <i class="fa fa-envelope"></i>
      </a>
      
      
      <a href="https://www.linkedin.com/in/villegasjose" data-animate-hover="pulse">
        <i class="fa fa-linkedin"></i>
      </a>
      
      
      
      <a href="https://github.com/jose-villegas" data-animate-hover="pulse">
        <i class="fa fa-github"></i>
      </a>
      

    </div>
  </div>
</div>

          </div>
        </div>
      </div>
    </div>
    <script src="https://jose-villegas.github.io/js/jquery.min.js"></script>
<script src="https://jose-villegas.github.io/js/bootstrap.min.js"></script>
<script src="https://jose-villegas.github.io/js/jquery.cookie.js"> </script>
<script src="https://jose-villegas.github.io/js/ekko-lightbox.js"></script>
<script src="https://jose-villegas.github.io/js/jquery.scrollTo.min.js"></script>
<script src="https://jose-villegas.github.io/js/masonry.pkgd.min.js"></script>
<script src="https://jose-villegas.github.io/js/imagesloaded.pkgd.min.js"></script>
<script src="https://jose-villegas.github.io/js/owl.carousel.min.js"></script>
<script src="https://jose-villegas.github.io/js/front.js"></script>

  </body>
</html>
